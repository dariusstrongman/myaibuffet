name: Regenerate Articles with SEO Enhancements

# Runs automatically when articles or scripts are updated
# Also allows manual trigger for one-time regeneration
on:
  # Automatic trigger: when article scripts or articles change
  push:
    branches:
      - main
    paths:
      - 'scripts/generate-article-pages.js'
      - 'scripts/seo-enhancements.js'
      - 'articles/rss/**'

  # Manual trigger: for one-time regeneration or testing
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "REGENERATE" to confirm (or leave default)'
        required: false
        default: 'REGENERATE'

jobs:
  regenerate-articles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check trigger type
        run: |
          # Prevent infinite loop: Don't run if last commit was SEO regeneration
          LAST_COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          if [[ "$LAST_COMMIT_MSG" == *"SEO Enhancement: Regenerate articles"* ]]; then
            echo "ğŸ”„ Last commit was SEO regeneration - skipping to prevent loop"
            echo "â„¹ï¸  Articles are already up to date with SEO enhancements"
            exit 0
          fi

          if [ "${{ github.event_name }}" = "push" ]; then
            echo "ğŸ¤– Triggered automatically by push to main branch"
            echo "ğŸ“ Articles or scripts were updated - regenerating with SEO enhancements"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.confirm }}" != "REGENERATE" ]; then
              echo "âŒ Manual trigger requires 'REGENERATE' confirmation"
              exit 1
            fi
            echo "ğŸ‘¤ Triggered manually - regenerating all articles"
          fi
          echo "âœ… Trigger verified"

      - name: Backup existing articles
        run: |
          echo "ğŸ“¦ Creating backup..."
          BACKUP_DIR="articles/rss_backup_$(date +%Y%m%d_%H%M%S)"
          mkdir -p "$BACKUP_DIR"
          cp -r articles/rss/*.html "$BACKUP_DIR/" 2>/dev/null || echo "No existing articles to backup"
          echo "âœ… Backup created at: $BACKUP_DIR"
          echo "BACKUP_DIR=$BACKUP_DIR" >> $GITHUB_ENV

      - name: Remove old articles
        run: |
          echo "ğŸ—‘ï¸  Removing old articles to trigger regeneration..."
          rm -f articles/rss/*.html
          echo "âœ… Old articles removed"

      - name: Regenerate articles with SEO enhancements
        run: |
          echo "ğŸ”„ Regenerating all articles with enhanced SEO..."
          npm run generate-articles
          echo "âœ… Regeneration complete!"

      - name: Check generated files
        run: |
          ARTICLE_COUNT=$(find articles/rss -name "*.html" -type f | wc -l)
          echo "ğŸ“Š Generated $ARTICLE_COUNT article pages"

          if [ "$ARTICLE_COUNT" -lt 800 ]; then
            echo "âš ï¸  Warning: Expected ~900+ articles, but only generated $ARTICLE_COUNT"
            echo "This might indicate an issue. Please check logs."
          else
            echo "âœ… Article count looks good!"
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add articles/rss/
          git add sitemap.xml

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit (all articles already up to date)"
          else
            git commit -m "ğŸš€ SEO Enhancement: Regenerate articles with reading time, related articles, and enhanced schemas

            - Added reading time calculator
            - Implemented smart related articles matching
            - Enhanced structured data (Article + Breadcrumb schemas)
            - Improved internal linking
            - Better SEO signals for Google

            Generated by GitHub Actions workflow"

            git push
            echo "âœ… Changes pushed to GitHub!"
          fi

      - name: Summary
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                   â•‘"
          echo "â•‘  âœ… SEO REGENERATION COMPLETE!                    â•‘"
          echo "â•‘                                                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š What was done:"
          echo "   â€¢ Backed up existing articles"
          echo "   â€¢ Regenerated all articles with:"
          echo "     âœ“ Reading time badges"
          echo "     âœ“ Smart related articles"
          echo "     âœ“ Enhanced structured data"
          echo "     âœ“ Breadcrumb navigation"
          echo ""
          echo "ğŸš€ Your articles now have enterprise-level SEO!"
          echo ""
          echo "ğŸ“ˆ Expected results:"
          echo "   â€¢ 20-30% higher CTR (rich snippets)"
          echo "   â€¢ Lower bounce rate (related articles)"
          echo "   â€¢ Better rankings (internal linking)"
          echo ""
          echo "ğŸ” Next steps:"
          echo "   1. Wait for GitHub Pages to deploy (~2-5 min)"
          echo "   2. Test: https://myaibuffet.com/articles/rss/"
          echo "   3. Verify rich results: https://search.google.com/test/rich-results"
          echo "   4. Monitor Google Search Console"
          echo ""
